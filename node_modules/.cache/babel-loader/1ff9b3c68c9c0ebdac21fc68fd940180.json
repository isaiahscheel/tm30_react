{"ast":null,"code":"'use strict';\n\nvar barycentric = require('barycentric');\n\nvar closestPointToTriangle = require('polytope-closest-point/lib/closest_point_2d.js');\n\nmodule.exports = closestPointToPickLocation;\n\nfunction xformMatrix(m, v) {\n  var out = [0, 0, 0, 0];\n\n  for (var i = 0; i < 4; ++i) {\n    for (var j = 0; j < 4; ++j) {\n      out[j] += m[4 * i + j] * v[i];\n    }\n  }\n\n  return out;\n}\n\nfunction projectVertex(v, model, view, projection, resolution) {\n  var p = xformMatrix(projection, xformMatrix(view, xformMatrix(model, [v[0], v[1], v[2], 1])));\n\n  for (var i = 0; i < 3; ++i) {\n    p[i] /= p[3];\n  }\n\n  return [0.5 * resolution[0] * (1.0 + p[0]), 0.5 * resolution[1] * (1.0 - p[1])];\n}\n\nfunction barycentricCoord(simplex, point) {\n  if (simplex.length === 2) {\n    var d0 = 0.0;\n    var d1 = 0.0;\n\n    for (var i = 0; i < 2; ++i) {\n      d0 += Math.pow(point[i] - simplex[0][i], 2);\n      d1 += Math.pow(point[i] - simplex[1][i], 2);\n    }\n\n    d0 = Math.sqrt(d0);\n    d1 = Math.sqrt(d1);\n\n    if (d0 + d1 < 1e-6) {\n      return [1, 0];\n    }\n\n    return [d1 / (d0 + d1), d0 / (d1 + d0)];\n  } else if (simplex.length === 3) {\n    var closestPoint = [0, 0];\n    closestPointToTriangle(simplex[0], simplex[1], simplex[2], point, closestPoint);\n    return barycentric(simplex, closestPoint);\n  }\n\n  return [];\n}\n\nfunction interpolate(simplex, weights) {\n  var result = [0, 0, 0];\n\n  for (var i = 0; i < simplex.length; ++i) {\n    var p = simplex[i];\n    var w = weights[i];\n\n    for (var j = 0; j < 3; ++j) {\n      result[j] += w * p[j];\n    }\n  }\n\n  return result;\n}\n\nfunction closestPointToPickLocation(simplex, pixelCoord, model, view, projection, resolution) {\n  if (simplex.length === 1) {\n    return [0, simplex[0].slice()];\n  }\n\n  var simplex2D = new Array(simplex.length);\n\n  for (var i = 0; i < simplex.length; ++i) {\n    simplex2D[i] = projectVertex(simplex[i], model, view, projection, resolution);\n  }\n\n  var closestIndex = 0;\n  var closestDist = Infinity;\n\n  for (var i = 0; i < simplex2D.length; ++i) {\n    var d2 = 0.0;\n\n    for (var j = 0; j < 2; ++j) {\n      d2 += Math.pow(simplex2D[i][j] - pixelCoord[j], 2);\n    }\n\n    if (d2 < closestDist) {\n      closestDist = d2;\n      closestIndex = i;\n    }\n  }\n\n  var weights = barycentricCoord(simplex2D, pixelCoord);\n  var s = 0.0;\n\n  for (var i = 0; i < 3; ++i) {\n    if (weights[i] < -0.001 || weights[i] > 1.0001) {\n      return null;\n    }\n\n    s += weights[i];\n  }\n\n  if (Math.abs(s - 1.0) > 0.001) {\n    return null;\n  }\n\n  return [closestIndex, interpolate(simplex, weights), weights];\n}","map":null,"metadata":{},"sourceType":"script"}